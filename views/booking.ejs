<%- include('partials/header') %>
<%- include('partials/navbar') %>

<section class="section booking-section">
  <div class="container">
    <h1 class="section-title">Book Your Appointment</h1>

    <% if (success && success.length > 0) { %>
      <div class="alert alert-success"><%= success %></div>
    <% } %>

    <% if (error && error.length > 0) { %>
      <div class="alert alert-error"><%= error %></div>
    <% } %>

    <% if (errors && errors.length > 0) { %>
      <div class="alert alert-error">
        <% errors.forEach(e => { %><p><%= e.msg %></p><% }) %>
      </div>
    <% } %>

    <form action="/booking" method="POST" class="booking-form">
      <div class="form-grid">
        <div class="form-group">
          <label for="customerName">Full Name *</label>
          <input type="text" id="customerName" name="customerName" value="<%= oldInput.customerName || '' %>" required>
        </div>

        <div class="form-group">
          <label for="customerEmail">Email *</label>
          <input type="email" id="customerEmail" name="customerEmail" value="<%= oldInput.customerEmail || '' %>" required>
        </div>

        <div class="form-group">
          <label for="customerPhone">Phone *</label>
          <input type="tel" id="customerPhone" name="customerPhone" value="<%= oldInput.customerPhone || '' %>" required>
        </div>

        <div class="form-group">
          <label for="barber">Select Barber *</label>
          <select id="barber" name="barber" required>
            <option value="">Choose a barber...</option>
            <% barbers.forEach(barber => { %>
              <option value="<%= barber._id %>" <%= oldInput.barber == barber._id ? 'selected' : '' %>>
                <%= barber.name %> - <%= barber.specialty %>
              </option>
            <% }); %>
          </select>
        </div>

        <div class="form-group">
          <label for="service">Service *</label>
          <select id="service" name="service" required>
            <option value="">Choose a service...</option>
            <option value="Classic Haircut - $30">Classic Haircut - $30</option>
            <option value="Beard Trim - $20">Beard Trim - $20</option>
            <option value="Hot Towel Shave - $35">Hot Towel Shave - $35</option>
            <option value="The Works - $65">The Works - $65</option>
            <option value="Kids Cut - $20">Kids Cut - $20</option>
            <option value="Hair Coloring - $45">Hair Coloring - $45</option>
          </select>
        </div>

        <div class="form-group">
          <label for="date">Preferred Date *</label>
          <input type="date" id="date" name="date" value="<%= oldInput.date || '' %>" 
                 min="<%= new Date().toISOString().split('T')[0] %>" required>
        </div>

        <div class="form-group">
          <label for="time">Preferred Time *</label>
          <select name="time" id="time" required>
            <option value="">Select time</option>
            <% for(let h = 9; h <= 20; h++) { 
                 const hour = h.toString().padStart(2,'0'); %>
              <option value="<%= hour %>:00"><%= hour %>:00</option>
              <option value="<%= hour %>:30"><%= hour %>:30</option>
            <% } %>
          </select>
        </div>

        <div class="form-group full-width">
          <label for="notes">Additional Notes</label>
          <textarea id="notes" name="notes" rows="3"><%= oldInput.notes || '' %></textarea>
        </div>
      </div>

      <button type="submit" class="btn-primary btn-large">Book Appointment</button>
    </form>
  </div>
</section>

<script>
const barberSelect = document.querySelector('select[name="barber"]');
const dateInput = document.querySelector('input[name="date"]');
const timeSelect = document.querySelector('#time');

async function updateBookedTimes() {
  const barberId = barberSelect.value;
  const date = dateInput.value;
  if (!barberId || !date) return;

  try {
    const res = await fetch(`/booking/booked-times/${barberId}/${date}`);
    const data = await res.json();
    const booked = data.times;

    // Enable all first
    Array.from(timeSelect.options).forEach(opt => opt.disabled = false);

    // Disable booked slots
    booked.forEach(t => {
      const option = Array.from(timeSelect.options).find(opt => opt.value === t);
      if (option) option.disabled = true;
    });
  } catch (err) {
    console.error('Failed to fetch booked times:', err);
  }
}

// Update when barber or date changes
barberSelect.addEventListener('change', updateBookedTimes);
dateInput.addEventListener('change', updateBookedTimes);

// Update on page load if values exist
window.addEventListener('DOMContentLoaded', updateBookedTimes);
</script>

<%- include('partials/footer') %>
